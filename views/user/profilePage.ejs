<%- include("../../views/partials/user/header") %>

<!-- style here -->
<style>
 .card-green {
   background-color: #ADD8E6;
 }
 .main {
   padding: 30px 0;
 }

 .dashboard-menu {
   background-color: #cce3e6;
   border-radius: 10px;
   padding: 15px;
   box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
 }

 .dashboard-menu .nav-link {
 font-weight: bold;
 color: #30683c;
 box-shadow: 0 4px 10px rgba(123, 131, 112, 0.3), 0 4px 20px rgba(0, 191, 255, 0.2);
 transition: box-shadow 0.3s ease;
}

.dashboard-menu .nav-link:hover {
 color: #00bfff;
 box-shadow: 0 4px 15px rgba(173, 255, 47, 0.5), 0 6px 25px rgba(0, 191, 255, 0.4);
}

 .card {
   border-radius: 10px;
   box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
   margin-bottom: 20px;
 }

 .card-header {
   background-color: #487379;
   color: white;
   border-radius: 10px 10px 0 0;
 }

 .form-group {
   margin-bottom: 15px;
 }

 .required {
   color: red;
 }

  @media (max-width: 768px) {
   .dashboard-menu {
     padding: 10px;
   }


   .card {
     margin-bottom: 15px;
   }
 }

 .page-header.breadcrumb-wrap {
 background-color: #f1f1f1;
 padding: 15px 0;
}

.breadcrumb {
 display: flex;
 align-items: center;
 font-family: 'Arial', sans-serif;
 font-size: 16px;
 color: #121311;
}

.breadcrumb a {
 color: #007bff;
 text-decoration: none;
 position: relative;
 margin: 0 5px;
}

.breadcrumb a:hover {
 color: #0056b3;
}

.breadcrumb span {
 margin: 0 5px;
 color: #999;
}

.breadcrumb a::after {
 content: '';
 position: absolute;
 width: 100%;
 height: 2px;
 background: #6e6e3a;
 left: 0;
 bottom: -2px;
 transform: scaleX(0);
 transition: transform 0.3s ease;
}

.breadcrumb a:hover::after {
 transform: scaleX(1);
}
</style>

<!-- contents of profile page starts here -->
<main class="main">
 <div class="page-header breadcrumb-wrap mb-3">
   <div class="container">
     <div class="breadcrumb">
       <a href="/" rel="nofollow">Home</a>
       <span></span> Profile <span></span> Account
     </div>
   </div>
 </div>
  <section class="pt-10 pb-10">
    <div class="container">
      <div class="row">
        <div class="col-lg-10 m-auto">
          <div class="row">
            <div class="col-md-4">
              <div class="dashboard-menu" style="background-color: rgb(224, 224, 224);">
                <ul class="nav flex-column" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" role="tab" aria-controls="dashboard" aria-selected="true">
                      <i class="fi-rs-settings-sliders mr-10"></i>Dashboard
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="address-tab" data-bs-toggle="tab" data-bs-target="#address" role="tab" aria-controls="address" aria-selected="false">
                      <i class="fi-rs-marker mr-10"></i>My Address
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" role="tab" aria-controls="orders" aria-selected="false">
                      <i class="fi-rs-shopping-bag mr-10"></i>Orders
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="wallet-status-tab" data-bs-toggle="tab" data-bs-target="#track-orders" role="tab" aria-controls="track-orders" aria-selected="false">
                      <i class="fi-rs-wallet mr-10"></i>Wallet Status
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="wallet-history-tab" data-bs-toggle="tab" data-bs-target="#wallet-history" role="tab" aria-controls="wallet-history" aria-selected="false">
                      <i class="fi-rs-clock mr-10"></i>Wallet History
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#referal" role="tab" aria-controls="track-orders" aria-selected="false">
                      <i class="fi-rs-shopping-cart-check mr-10"></i>Referals
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            <div class="col-md-8">
              <div class="tab-content dashboard-content">
                <!-- Dashboard Tab -->

                <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                  <div class="card card-green">
                      <div class="card-header" style="background-color: rgb(224, 224, 224);">
                          <h5 class="mb-0 text-center">User Profile</h5>
                      </div>
                      <div class="card-body text-center" style="background-color: white;">
                          <h5 class="card-title"><%= user.name %></h5>
                          <p class="card-text">
                              <strong>Phone:</strong>
                              <%= user.phone ? user.phone : "Not Available" %>
                          </p>
                          <p class="card-text"><strong>Email:</strong> <%= user.email %></p>
              
                          <!-- Button Group for Actions -->
                          <div class="row justify-content-center">
                              <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-2">
                                  <a href="/changeEmail" class="btn btn-block btn-sm btn-success">Change Email</a>
                              </div>
                              <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-2">
                                  <a href="/changePasswordFromProfile" class="btn btn-block btn-sm btn-success">Change Password</a>
                              </div>
                              <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-2">
                                  <% if(user.phone) { %>
                                      <a href="/changePhone" class="btn btn-block btn-sm btn-success">Change Phone</a>
                                  <% } else { %>
                                      <a href="/changePhone" class="btn btn-block btn-sm btn-success">Add Phone</a>
                                  <% } %>
                              </div>
                              <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-2">
                                  <a href="/logout" class="btn btn-block btn-sm btn-warning">Logout</a>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

                <!-- Address Tab -->
                <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                  <div class="row">
                    <% if(userAddress) { %>
                      <% userAddress.address.forEach(address => { %>
                        <div class="col-lg-6">
                          <div class="card mb-3">
                            <div class="card-header"><h5 class="mb-0"><%= address.addressType %></h5></div>
                            <div class="card-body">
                              <address>
                                <%= address.name %> <br /> <%= address.landMark %> <br>
                                <%= address.city %>, <%= address.state %>, <%= address.pincode %>
                              </address>
                              <p><%= address.phone %>, <%= address.altPhone %></p>
                              <div class="d-flex justify-content-between">
                                <a href="editAddress?id=<%= address._id %>" class="btn-small">Edit</a>
                                <a href="#" class="btn-small" onclick="return confirmDelete(event, '<%= address._id %>')">Delete</a>
                              </div>
                            </div>
                          </div>
                        </div>
                      <% }) %>
                    <% } else { %>
                      <div class="col-lg-6"><p>No address found.</p></div>
                    <% } %>
                    <div>
                      <a href="/addAddress"><button class="btn  w-70 mt-3">Add Address</button></a>
                    </div>
                  </div>
                </div>
                <!-- Orders Tab -->
                <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                  <div class="card">
                    <div class="card-header"><h5 class="mb-0">Your Orders</h5></div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table">
                          <thead><tr><th>Order</th><th>Status</th><th>Total</th><th>Actions</th></tr></thead>
                          <tbody>
                            <% if(order) { %>
                              <% order.forEach(order => { %>
                                <tr>
                                  <td>
                                    <% order.orderedItems.forEach(item => { %>
                                      <%= item.productName %><br>
                                    <% }) %>
                                  </td>
                                  <td>
                                    <% order.orderedItems.forEach(item => { %>
                                      <%= item.productStatus %><br>
                                    <% }) %>
                                  </td>
                                  <td><%= order.finalAmount %></td>
                                  <td><a href="/orderDetails?id=<%= order._id %>" class="btn-small d-block">View</a></td>
                                </tr>
                              <% }) %>
                            <% } %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Wallet Status Tab -->
                <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="wallet-status-tab">
                  <div class="card">
                    <div class="card-header"><h5 class="mb-0">Wallet: â‚¹ <%= user.wallet %></h5></div>
                    <div class="card-body">
                      <form>
                        <label for="walletAmount" class="h4">Amount</label> <br>
                      </form>
                    </div>
                  </div>
                </div>
                <!-- Wallet History Tab -->
                <div class="tab-pane fade" id="wallet-history" role="tabpanel" aria-labelledby="wallet-history-tab">
                  <div class="card">
                    <div class="card-header"><h5 class="mb-0">Wallet History</h5></div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <% if(order.status) %>
                        <table class="table">
                          <thead>
                            <tr>
                              <th>Date</th>
                              <th>Status</th>
                              <th>Amount</th>
                            </tr>
                          </thead>
                          <tbody> 
                            <% let walletTransactions = user.wallet %>
                            <% if(walletTransactions) { %>
                               %>
                                <% user.walletHistory.forEach((element)=>{ %>
                                  <% if(element.transactionDate) {%>
                              <tr>  
                                  <td><%= element.transactionDate.toLocaleString('en-IN') %></td>
                                  <td><%= element.transactionType %></td> 
                                  <td><%= element.transactionAmount %></td>
                              </tr>
                                <% } %>
                                <% }) %>                             
                            <% } else { %>
                              <tr><td colspan="3" class="text-center">No Transactions Found</td></tr>
                            <% } %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="tab-pane fade" id="referal" role="tabpanel" aria-labelledby="track-orders-tab">
                  <div class="card">
                    <div class="card-header">
                      <h5 class="mb-0">Referal</h5>
                    </div>
                    <div class="card-body">
                      <h6 class="mb-3">Refer your friends and earn money! You get 100Rs and new user get 50Rs to the wallet</h6>
                      <% if(user.referalCode) {%>
                      <p>Click on the link to Share: <strong><input type="text"  onclick="clipBoard()"  id="referalCode" value=https://www.gentzgallery.online/signup?ref=<%= user.referalCode %>> </strong></p> 
                      <% }else {%>
                        <button class="btn" onclick="generateReferal('<%= user._id%>')">Generate referal link</button>
                        <% } %>
                      
                    </div>
                  </div>
                </div> 
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- script for performing operations in the user profile page -->
<script>
  
  //function for alert and delete ajax request
  function confirmDelete(event, addressId) {
    event.preventDefault(); 

    Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: `deleteAddress?id=${addressId}`,
                method: 'get',
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: "success",
                            title: "Deleted",
                            text: response.message, 
                            showConfirmButton: true,
                        }).then(() => {
                            window.location.href = response.redirectUrl; 
                        });
                    } else {
                        Swal.fire(
                            'Error!',
                            response.message,
                            'error'
                        );
                    }
                },
                error: function (error) {
                    console.error('Error:', error);
                    Swal.fire(
                        'Error!',
                        'Failed to delete address.',
                        'error'
                    );
                }
            });
        }
    });
  }


  //script for changing the active tab in the user profile page
  document.querySelectorAll('.dashboard-menu .nav-link').forEach(tab => {
  tab.addEventListener('click', function (event) {
    event.preventDefault(); 
    let tabID = this.getAttribute('data-bs-target');
    document.querySelectorAll('.tab-pane').forEach(tabPane => {
      tabPane.classList.remove('show', 'active');
    });    
    document.querySelector(tabID).classList.add('show', 'active');
  });
});

function generateReferal(userId){
  $.ajax({
    url:`/generateReferal?id=${userId}`,
    method:'get',
    success:((response)=>{
      if(response.success){
        Swal.fire({
          icon:"success",
          title:"success",
          text:response.message
        })
        window.location.href=response.redirectUrl;
      }else{
        Swal.fire({
          icon:"error",
          title:"error",
          text:response.message,
        });
      }
    })
  })
}

function clipBoard() {
  // Get the text field
  var copyText = document.getElementById("referalCode");

  // Select the text field
  copyText.select();
  copyText.setSelectionRange(0, 99999); // For mobile devices

   // Copy the text inside the text field
  navigator.clipboard.writeText(copyText.value);

  // Alert the copied text
  
  Swal.fire({
      text: "Copied the link to clip board" 
    });
}

</script>


<%- include("../../views/partials/user/footer") %>






