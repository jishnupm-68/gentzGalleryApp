<%- include("../../views/partials/user/header") %>


<!-- content -->
<section class="p-3 p-md-4 p-xl-5">
    <div class="container  ">
      <div class=" ">
        <div class="row g-0 justify-content-center align-items-center">
          <div
            class="col-12 col-md-6 col-lg-4 d-flex justify-content-center align-items-center  card border-light-subtle shadow-sm">
            <div class="card-body p-3 p-md-4 p-xl-5" style="background-color: rgb(224, 224, 224);">
              <div class="row">
                <div class="col-12">
                  <div class="mb-5">
                    <h3 class="h3">Change your Email Account </h3>
                  </div>
                </div>
              </div>
              <form id="loginForm" onsubmit="return validateForm()">
                <div class="row gy-3 gy-md-4 overflow-hidden">
                  <div class="col-12">
                    <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                    <input type="text" class="form-control bg-white" name="email" id="email" placeholder="name@example.com">
                  </div>
                  <div id="errorInEmail" class="error-message   text-danger"></div> 
                  <%if(locals.message && message.length>0){%>
                    <div class="alert alert-danger text-center text-warning">
                    <h6 class="h6 text-danger"> <%=message%></h6>
                    </div>
                  <%}%>
                    <div class="col-12">
                      <div class="d-grid">
                        <button class="btn bsb-btn-xl " type="submit">Submit</button>
                      </div>
                    </div>        
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

<!-- script for validating email and ajax request -->
<script>
  const emailid = document.getElementById("email");
  const errorInEmail = document.getElementById("errorInEmail");
  const loginform = document.getElementById("loginForm");

  //function for email validation
  function emailValidateChecking(e) {
    const emailval = emailid.value;
    const emailpattern =
      /^[a-zA-Z0-9._-]+@([a-zA-Z0-9.-]+)\.([a-zA-Z]{2,4})$/;

    if (!emailpattern.test(emailval)) {
      errorInEmail.style.display = "block";
      errorInEmail.innerHTML = "Invalid Format";
      return false;
    } else {
      errorInEmail.style.display = "none";
      errorInEmail.innerHTML = "";
      return true;
    }
  }


  //validate and ajax request
  function validateForm(){
    const value = emailValidateChecking()
    if(value){
        const emailval = emailid.value;
        $.ajax({
            url:"changeEmail",
            type:"POST",
            data:{email:emailval},
            success:function(response){
                if(response.success){
                  Swal.fire({
                    icon: "success",
                    title: "Email verified successfully",
                    text: "",
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                  }).then(()=>{
                    location.href = response.redirectUrl;
                  })
                }else{
                  Swal.fire({
                    icon: "error",
                    title: "Failed to change email",
                    text: "The email do not match with this account",
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                  })
                }
            },
            error: function(error){
              console.error("Error:", error);
              Swal.fire({
                icon: "error",
                title: "Failed to change email",
                text: response.message,
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
              })
            }
        })
    }else{
        return false
    }
  }

  //event listener for form submission
  document.addEventListener("DOMContentLoaded", function () {
    loginform.addEventListener("submit", function (e) {
      e.preventDefault();
      emailValidateChecking();
      if (!emailid || !errorInEmail ||  !loginform) {
        console.error("One or more elements not found");
      }
      if (errorInEmail.innerHTML ) {
        e.preventDefault();
      }
    });
  });
</script>

<!-- footer -->
<%- include("../../views/partials/user/footer") %>