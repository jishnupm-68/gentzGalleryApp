<%- include("../../views/partials/admin/header") %>

<style>
 .col-md-3 {
   padding: 20px;
   border: 1px solid #ddd;
   border-radius: 10px;
   margin: 10px;
 }

 .error-message {
   color: red;
   margin-top: 5px;
 }

 .form-label {
   margin-bottom: 8px;
 }

 .form-control {
   width: 100%;
   padding: 8px;
   margin-bottom: 10px;
   border: 1px solid #ccc;
   border-radius: 5px;
   box-sizing: border-box;
 }

 .d-grid {
   margin-top: 20px;
 }

 .btn-primary {
   background-color: #007bff;
   color: #fff;
   border: 1px solid #007bff;
   border-radius: 5px;
   padding: 10px 20px;
   cursor: pointer;
 }

 .btn-primary:hover {
   background-color: #0056b3;
   border-color: #0056b3;
 }
</style>


<section class="content-main" style="margin-left: 20%; padding-top: 5%;">
 <div class="content-header">
   <div>
     <h2 class="content-title card-title">Coupon-Edit</h2>
   </div>
 </div>
 <div class="card">
   <div class="card-body">
     <div class="row">
       <div class="col-md-3">
         <form id="coupon-form" method="post" action="#">
           <% let findCoupon = coupon %>
           <input type="hidden" id="coupon-id" value="<%= findCoupon._id %>" />
           <div class="mb-4">
             <label for="coupon-name" class="form-label">Coupon Name</label>
             <input
               type="text"
               id="coupon-name"
               value="<%= findCoupon.name%>"
               name="couponName"
               placeholder="Type here"
               class="form-control"
             />
             <div id="error-coupon-name" class="error-message"></div>
           </div>
           <div>
            <% console.log("dates",findCoupon, findCoupon.createdOn, findCoupon.expireOn) %>
             <label for="startingDate" class="form-label">Start Date</label>
             <input type="date" name="startDate" class="form-control" value="<%= new Date(findCoupon.createdOn).toISOString().split('T')[0] %>" id="startingDate" disabled/>
             <div id="error-start-date" class="error-message"></div>
           </div>
           <div>
             <label for="expiringDate" class="form-label">End Date</label>
             <input
                type="date"
                name="endDate"
                class="form-control"
                id="expiringDate"
                value="<%= new Date(findCoupon.expireOn).toISOString().split('T')[0] %>"
              />
             <div id="error-end-date" class="error-message"></div>
           </div> 
           <!-- selecting the option -->
           <div>
            <label for="offerType" class="form-label">Select Offer Type</label>
            <select id="offerType" name="offerType" class="form-control">
                <option value="" disabled>-- Select Offer Type --</option>
                <option value="percentage"  disabled <%= findCoupon.percentageOffer >0 ? 'selected' : '' %>>Percentage Offer</option>
                <option value="flat"  disabled <%= findCoupon.percentageOffer ==0 ? 'selected' : '' %>>Flat Discount</option>
            </select>
        </div>
        
        <!-- Percentage Offer Fields -->
        <div id="percentageFields" style="display: none;">
            <label for="percentageOffer" class="form-label">Percentage Offer</label>
            <input type="number" id="percentageOffer" name="percentageOffer" class="form-control" min="1" max="100" placeholder="%" value="<%= findCoupon.percentageOffer || '' %>"/>
            <div id="error-percentage-offer" class="error-message text-danger"></div>        
            <label for="minAmount" class="form-label mt-2">Minimum Purchase Amount</label>
            <input type="number" id="minAmount" name="minAmount" class="form-control" min="1" value="<%= findCoupon.minimumPrice || '' %>" />
            <div id="error-min-amount" class="error-message text-danger"></div>       
            <label for="maxAmount" class="form-label mt-2">Maximum Discount</label>
            <input type="number" id="maxAmount" name="maxAmount" class="form-control" min="1" value="<%= findCoupon.offeredPrice    || '' %>" />
            <div id="error-max-amount" class="error-message text-danger"></div>
        </div>
        
        <!-- Flat Discount Fields -->
        <div id="flatFields" style="display: none;">
            <label for="flatAmount" class="form-label">Flat Discount</label>
            <input type="number" id="flatAmount" name="flatAmount" class="form-control" min="1" placeholder="â‚¹" value="<%= findCoupon.offeredPrice|| '' %>" />
            <div id="error-flat-amount" class="error-message text-danger"></div>       
            <label for="minPurchase" class="form-label mt-2">Minimum Purchase Amount</label>
            <input type="number" id="minPurchase" name="minPurchase" class="form-control" min="1" value="<%= findCoupon.minimumPrice  || '' %>" />
            <div id="error-min-purchase" class="error-message text-danger"></div>
        </div>
           <div class="d-grid">
             <button id="update-coupon" type="submit" class="btn btn-primary mt-20"  onclick=" validateForm(this)">Update Coupon</button>
             <button onclick="window.location.href = '/admin/coupon'" class="btn  mt-20 btn-warning p-2 ml-4" type="submit">Cancel</button>
           </div>
           <div id="err-msg" class="error-message"></div>
         </form>
       </div>
     </div>
   </div>
 </div>
</section>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<input type="text" name="couponId" id="couponId" value="<%= findCoupon._id %>" hidden>

<!-- script for handling types of coupon -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
      const offerType = document.getElementById("offerType");
      const percentageFields = document.getElementById("percentageFields");
      const flatFields = document.getElementById("flatFields");

      function toggleFields() {
          if (offerType.value === "percentage") {
              percentageFields.style.display = "block";
              flatFields.style.display = "none";
          } else if (offerType.value === "flat") {
              percentageFields.style.display = "none";
              flatFields.style.display = "block";
          } else {
              percentageFields.style.display = "none";
              flatFields.style.display = "none";
          }
      }
      offerType.addEventListener("change", toggleFields);
      toggleFields(); 
  });
</script>


<!-- script for validation  and ajax request -->
<script>
//function for validating input fields and ajax requests
function validateForm(e) {
   
    let form = document.getElementById("couponForm");
    e.preventDefault();
    document.querySelectorAll(".error-message").forEach(el => el.innerHTML = "");

    //validation values
    const sDate = document.getElementsByName("startDate")[0].value;
    const eDate = document.getElementsByName("endDate")[0].value;
    const offerType = document.getElementById("offerType").value;

    // Percentage Discount Fields
    let percentageOffer = document.getElementsByName("percentageOffer")[0].value;
    const minAmount = document.getElementsByName("minAmount")[0].value;
    const maxAmount = document.getElementsByName("maxAmount")[0].value;

    // Flat Discount Fields
    const flatAmount = document.getElementsByName("flatAmount")[0].value;
    const minPurchase = document.getElementsByName("minPurchase")[0].value;

    
    if (offerType === "percentage") {
        if (!percentageOffer) {
            document.getElementById("error-percentage-offer").innerHTML = "Percentage Offer is required";
            return false;
        }
        if (percentageOffer <= 0 || percentageOffer > 100) {
            document.getElementById("error-percentage-offer").innerHTML = "Percentage Offer should be between 1 and 100";
            return false;
        }
        if (!minAmount) {
            document.getElementById("error-min-amount").innerHTML = "Minimum Purchase Amount is required";
            return false;
        }
        if (!maxAmount) {
            document.getElementById("error-max-amount").innerHTML = "Maximum discount is required";
            return false;
        }
        if (parseFloat(minAmount) < parseFloat(maxAmount)) {
            document.getElementById("error-min-amount").innerHTML = "Minimum purchase amount should be greater than or equal to Maximum discount";
            return false;
        }
    } else if (offerType === "flat") {
        if (!flatAmount) {
            document.getElementById("error-flat-amount").innerHTML = "Flat discount is required";
            return false;
        }
        if (flatAmount <= 0) {
            document.getElementById("error-flat-amount").innerHTML = "Flat discount should be greater than 0";
            return false;
        }
        if (!minPurchase) {
            document.getElementById("error-min-purchase").innerHTML = "Minimum Purchase is required";
            return false;
        }
        if(parseFloat(flatAmount) > parseFloat(minPurchase)) {
          document.getElementById("error-flat-amount").innerHTML = "Flat discount should be less than or equal to Minimum purchase amount";
            return false;  
    }
  }

    // Date Validation
    const sDateObj = new Date(sDate);
    const eDateObj = new Date(eDate);
    const todayDateObj = new Date();
    todayDateObj.setHours(0, 0, 0, 0);

    if (!eDate) {
        document.getElementById("error-end-date").innerHTML = "End date is required";
        return false;
    }
    if (sDateObj > eDateObj) {
        document.getElementById("error-end-date").innerHTML = "End date should be after the start date";
        return false;
    }

    let name = document.getElementsByName("couponName")[0].value;
    const nameRegex = /^[A-Za-z0-9\s]{1,50}$/; // Now allows spaces

    if (!nameRegex.test(name)) {
        document.getElementById("error-coupon-name").innerHTML = "Coupon Name should only contain letters, numbers, and spaces";
        return false;
    }
    percentageOffer = percentageOffer>0?percentageOffer:0;
    let offeredPrice = percentageOffer>0?maxAmount:flatAmount;
    let minimumPrice = percentageOffer>0?minAmount:minPurchase;
    //ajax request
    $.ajax({
      url: "/admin/updatecoupon",
      method: "POST",
      data: {
        couponId: (document.getElementById("couponId").value),
        couponName: name,
        startDate: sDate,
        endDate: eDate,
        percentageOffer: percentageOffer, 
        offeredPrice:offeredPrice,
        minimumPrice: minimumPrice
      },
      success: function (response) {
        if(response.success){
          Swal.fire({
            icon: "success",
            title: "Coupon updated!",
            text: response.message,
            confirmButtonText: "OK",
          }).then(() => {
            window.location.href = response.redirectUrl;
          });
        }else{
          Swal.fire({
            icon: "error",
            title: "Error",
            text: response.message,
            confirmButtonText: "OK",
          });
        }
      }
    })
    return true;
}

//checking for event 
document.getElementById("coupon-form").addEventListener("submit", validateForm);

</script>
<%- include("../../views/partials/admin/footer") %>




